在内核启动时，内核知道物理内存DDR大小并且计算出高端内存的起始地址和内核空间的内存布局后，物理内存页面就要加入到伙伴系统中，那么物理内存页面如何增加到伙伴系统中呢？

伙伴系统(Buddy System)是操作系统中最常用的一种动态存储管理方法，在用户提出申请时，分配一块大小合适的内存块给用户，反之在用户释放内存块时回收。在伙伴系统中，内存块时2的order次幂。Linux内核中order的最大值用MAX_ORDER来表示，通过是11个内存块链表，每个内存块链表分别包括1、2、4、8、16、32、...、1024个连续页面。1024个页面对应着4MB大小的连续物理内存；

物理内存在Linux内核中分出几个zone来管理，zone根据内核的配置来划分，例如在ARM Vexpress平台上中，zone分为ZONE_NORMAL和ZONE_HIGHMEM。

伙伴系统的空闲页块如图2.2所示，zone的数据结构中有一个free_area数组，数组大小是MAX_ORDER。free_area数据结构中包含了MIGRATE_TYPE个链表，这里相当于zone中根据order的大小有0到MAX_ORDER-1个free_area，每个free_area根据MIGRATE_TYPES类型有几个相应的链表。

![伙伴系统的空闲页块管理](.\picture\伙伴系统的空闲页块管理.png)