malloc()函数返回的内存是否马上会分配物理内存？testA和testB分别在何时分配物理内存？

答：malloc函数其实是为用户空间分配进程地址空间，用内核术语来说就是分配一块VMA（VMALLOC的高端内存并不是指的这个VMA，VMA是指进程中4G地址空间，包括了VMALLOC的高端内存）,相当于一个空的纸箱。那什么时候才往纸箱子里装东西呢？有两种方式，一种是真正使用箱子的时候才往里面装东西，另一种是分配箱子的时候就装你想要的东西。进程A立马的testA函数就是这种情况，当使用这段内存时，CPU去查询页表，发现页表为空，CPU触发缺页中断，然后在缺页中断里一页一页的分配内存，需要一页给一页。进程B里面的testB函数，是第二种情况，直接分配已经装满的纸箱子，你要的虚拟内存都已经分配了物理内存并建立了页表映射。



假设不考虑libc的因素，malloc分配了100Byte，那么实际内核也是为其分配了100Byte吗？

答：处理器MMU的硬件单元是最小单位是页，所以内核分配内存、建立虚拟地址和物理地址映射关系都是以页为单位，PAGE_ALIGN(addr)宏让地址addr按页面大小对齐。



假设使用printf打印指针bufA和bufB指向的地址是一样的，那么在内核中这两块虚拟内存是否“打架”了呢？

答：其实每个用户进程都有自己的一份页表。每个进程有一个mm_struct数据结构，包含一个属于进程自己的页表、一个管理VMA的红黑树和链表。进程本身的VMA会挂入属于自己的红黑树和链表，所以即使进程A和进程B使用malloc分配内存返回相同的虚拟地址，但其实它们是两个不同的VMA，分别被不同的两套页表来管理。



vm_normal_page()函数返回的什么样的页面struct page数据结构？为什么内存管理代码需要这个函数？

答：该函数pte返回的normal maping的struct page数据结构，主要目的是过滤掉那些令人讨厌的special mapping的页面。



请简述get_user_page()函数的作用和实现流程。

答：用于把用户的虚拟内存空间传到内核空间，内核空间为其分配物理内存并建立相应的映射关系，实现过程如图2.17所示。例如，在camera驱动的V4L2核心架构中可以使用用户空间的内存类型（V4L2_MEMORY_USERPTR）来分配物理内存，其驱动的实现使用的是get_user_pages()函数。



请简述follow_page()函数的作用的实现过程。

答：通过虚拟地址addr寻找相应的物理页面，返回normal mapping页面对应的struct page数据结构，该函数回去查询页表。